import{u as H,b as P,c as D,j as e}from"./query-CLJXXnyt.js";import{a as p}from"./sentry-BmFBC7An.js";import{c as z,p as B,n as _,v as S,B as C,w as G,r as J,C as U,a as A,D as V,d as W,g as X,e as Y,f as Z,t as N,x as ee,y as te,z as se}from"./index-B7gfWGL-.js";import{S as u}from"./skeleton-wH4GlXrJ.js";import{t as r}from"./arabic-utils-DbmNOh8M.js";import{S as ae}from"./share-2-C0CuHnV6.js";import"./ui-vendor-Dbbq2re4.js";import"./router-Di6JPJcB.js";import"./firebase-app-B16QGRlq.js";const re=[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]],M=z("flame",re),ne=new Date(2026,1,18),le=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"],ie=[2,4,6,8,10,11];function y(n){return n===2?"ركعتين":n>=3&&n<=10?"ركعات":"ركعة"}function ce(n){const i=new Date(ne);i.setDate(i.getDate()+n-1);const d=`${r(n)} رمضان`,x=`${r(i.getDate())} ${le[i.getMonth()]}`;return{hijri:d,gregorian:x}}function Q(){return e.jsxs("div",{className:"container py-6",children:[e.jsxs("div",{className:"mb-6 rounded-xl bg-white p-4 shadow-card",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx(u,{className:"h-6 w-36"}),e.jsx(u,{className:"h-8 w-20 rounded-md"})]}),e.jsx(u,{className:"mb-1 h-4 w-48"}),e.jsx(u,{className:"mb-3 h-3 w-full rounded-full"}),e.jsx(u,{className:"h-6 w-28 rounded-full"})]}),e.jsx("div",{className:"grid grid-cols-4 gap-2 sm:grid-cols-5 md:grid-cols-6 md:gap-3",children:Array.from({length:30},(n,i)=>e.jsx(u,{className:"min-h-[72px] rounded-xl"},i))})]})}function je(){const{isAuthenticated:n,isLoading:i,token:d,user:x}=B(),[R,b]=p.useState(!1),[g,h]=p.useState(null),m=p.useRef(null),l=H(),{data:o,isLoading:q}=P({queryKey:["tracker"],queryFn:()=>se(d),enabled:n&&!!d}),f=new Set(o?.nights.map(t=>t.night)??[]),T=new Map(o?.nights.map(t=>[t.night,t])??[]),k=D({mutationFn:({night:t,rakaat:s})=>te(d,t,void 0,s),onMutate:async({night:t,rakaat:s})=>{await l.cancelQueries({queryKey:["tracker"]});const a=l.getQueryData(["tracker"]);return a&&l.setQueryData(["tracker"],{...a,nights:[...a.nights,{night:t,mosque_id:null,rakaat:s??null,attended_at:new Date().toISOString()}],stats:{...a.stats,attended:a.stats.attended+1}}),{previous:a}},onError:(t,s,a)=>{a?.previous&&l.setQueryData(["tracker"],a.previous),N.error("حدث خطأ، حاول مرة أخرى")},onSettled:()=>l.invalidateQueries({queryKey:["tracker"]})}),v=D({mutationFn:t=>ee(d,t),onMutate:async t=>{await l.cancelQueries({queryKey:["tracker"]});const s=l.getQueryData(["tracker"]);return s&&l.setQueryData(["tracker"],{...s,nights:s.nights.filter(a=>a.night!==t),stats:{...s.stats,attended:Math.max(0,s.stats.attended-1)}}),{previous:s}},onError:(t,s,a)=>{a?.previous&&l.setQueryData(["tracker"],a.previous),N.error("حدث خطأ، حاول مرة أخرى")},onSettled:()=>l.invalidateQueries({queryKey:["tracker"]})}),O=p.useCallback(t=>{f.has(t)?v.mutate(t):(m.current=t,h(t))},[f,v]),L=t=>{const s=m.current;s!==null&&(k.mutate({night:s,rakaat:t}),m.current=null,h(null))},$=()=>{const t=m.current;t!==null&&(k.mutate({night:t}),m.current=null,h(null))},F=t=>{t||(m.current=null,h(null))},K=()=>{if(!x||!o)return;const t=o.stats.attended,s=o.stats.current_streak;let a=`أكملت ${r(t)} ليلة تراويح`;s>1&&(a+=` (${r(s)} متتالية)`),a+=`
taraweeh.org/u/${x.username}`,navigator.clipboard.writeText(a),N.success("تم نسخ الإنجاز")};if(i)return e.jsx(Q,{});if(!n)return e.jsxs(e.Fragment,{children:[e.jsx(_,{children:e.jsx("title",{children:"متابعة التراويح - أئمة التراويح"})}),e.jsxs("div",{className:"container flex flex-col items-center gap-4 py-20 text-center",children:[e.jsx(S,{className:"h-16 w-16 text-muted-foreground/30"}),e.jsx("p",{className:"text-lg font-medium",children:"سجل دخولك لمتابعة حضورك"}),e.jsxs(C,{onClick:()=>b(!0),className:"h-12 px-8 text-base",children:[e.jsx(G,{className:"me-2 h-4 w-4"}),"تسجيل الدخول"]})]}),e.jsx(J,{open:R,onOpenChange:b})]});if(q)return e.jsx(Q,{});const c=o?.stats??{attended:0,current_streak:0,best_streak:0},w=Math.round(c.attended/30*100),j=o?.nights.reduce((t,s)=>t+(s.rakaat??0),0)??0;return e.jsxs(e.Fragment,{children:[e.jsx(_,{children:e.jsx("title",{children:"متابعة التراويح - أئمة التراويح"})}),e.jsxs("div",{className:"container py-6",children:[e.jsxs("div",{className:"mb-4 flex items-start gap-3 rounded-xl bg-primary/5 px-4 py-3 text-sm text-primary",children:[e.jsx(S,{className:"mt-0.5 h-5 w-5 shrink-0"}),e.jsx("p",{children:"تابع حضورك لصلاة التراويح خلال شهر رمضان ١٤٤٧ هـ. اضغط على الليلة لتسجيل حضورك."})]}),e.jsxs("div",{className:"mb-6 rounded-xl bg-white p-4 shadow-card",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-bold",children:"متابعة التراويح"}),e.jsxs(C,{variant:"outline",size:"sm",onClick:K,className:"gap-1.5",children:[e.jsx(ae,{className:"h-4 w-4"}),"مشاركة"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"mb-1 flex justify-between text-sm",children:[e.jsxs("span",{children:["أكملت ",r(c.attended)," من ٣٠ ليلة"]}),e.jsxs("span",{className:"text-muted-foreground",children:[r(w),"٪"]})]}),e.jsx("div",{className:"h-3 overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary transition-all duration-500",style:{width:`${w}%`}})})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[c.current_streak>0&&e.jsxs("div",{className:"flex items-center gap-1.5 rounded-full bg-orange-50 px-3 py-1 text-sm text-orange-700",children:[e.jsx(M,{className:"h-4 w-4"}),r(c.current_streak)," متتالية"]}),c.best_streak>1&&c.best_streak!==c.current_streak&&e.jsxs("div",{className:"flex items-center gap-1.5 rounded-full bg-amber-50 px-3 py-1 text-sm text-amber-700",children:[e.jsx(M,{className:"h-4 w-4"}),"أفضل: ",r(c.best_streak)]}),j>0&&e.jsxs("div",{className:"flex items-center gap-1.5 rounded-full bg-primary/10 px-3 py-1 text-sm text-primary",children:["أكملت ",r(j)," ",y(j)]})]})]}),e.jsx("div",{className:"grid grid-cols-4 gap-2 sm:grid-cols-5 md:grid-cols-6 md:gap-3",children:Array.from({length:30},(t,s)=>s+1).map(t=>{const s=f.has(t),a=T.get(t),{hijri:E,gregorian:I}=ce(t);return e.jsxs("button",{onClick:()=>O(t),className:A("relative flex min-h-[80px] flex-col items-center justify-center rounded-xl border-2 transition-all duration-200","active:scale-95",s?"border-primary bg-primary/15 text-primary shadow-sm":"border-border/60 bg-white text-muted-foreground hover:border-primary/30 hover:bg-primary/5"),children:[s&&e.jsx(U,{className:"absolute top-1 end-1 h-3.5 w-3.5 text-primary"}),e.jsx("span",{className:"text-xl font-bold",children:r(t)}),e.jsx("span",{className:"text-[10px] opacity-60",children:E}),e.jsx("span",{className:"text-[10px] opacity-50",children:I}),s&&a?.rakaat&&e.jsxs("span",{className:"mt-1 inline-flex rounded-full bg-primary/20 px-1.5 py-px text-[9px] font-bold text-primary",children:[r(a.rakaat)," ",y(a.rakaat)]})]},t)})})]}),e.jsx(V,{open:g!==null,onOpenChange:F,children:e.jsxs(W,{className:"max-w-xs sm:max-w-sm",children:[e.jsxs(X,{className:"text-center",children:[e.jsx(Y,{className:"text-xl",children:"كم عدد الركعات؟"}),e.jsxs(Z,{children:["الليلة ",g!==null?r(g):""]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2 pt-2",children:ie.map(t=>e.jsxs("button",{onClick:()=>L(t),className:A("flex flex-col items-center justify-center rounded-xl border-2 border-border/60 bg-white py-3 transition-all duration-150","hover:border-primary hover:bg-primary/10 active:scale-95"),children:[e.jsx("span",{className:"text-2xl font-bold text-primary",children:r(t)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:y(t)})]},t))}),e.jsx("button",{onClick:$,className:"mt-1 w-full text-center text-sm text-muted-foreground transition-colors hover:text-foreground",children:"تخطي"})]})})]})}export{je as TrackerPage};
